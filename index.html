<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التاريخ كما أراه - رحلة في الزمان والوعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Desert Sands & Papyrus -->
    <!-- Application Structure Plan: The SPA is structured as a progressive journey reflective of the narrative's call to "clear your mind" and explore history's cycles. It starts with an introductory "Haqiqa" (Truth/Reality) section challenging conventional views, followed by a detailed, interactive "Estidarat Al-Zaman" timeline. A new "Qisat Al-Khalifa Al-Awal" (Story of the First Caliph) section presents the first narrative with sequential "scenes" and visual/auditory cues, now with LLM-powered reflection. "Sunan & Lessons" summarize recurring patterns, enhanced with LLM-powered wisdom extraction. "Da'wat Lil Fa'l" (Call to Action) concludes. This structure prioritizes guided discovery and critical thinking, evolving from broad concepts to specific narratives. -->
    <!-- Visualization & Content Choices: 1. Inform/Challenge: Main introductory text. 2. Organize/Change: Interactive vertical timeline for cycles. 3. Narrative/Visual Storytelling: For "Qisat Al-Khalifa Al-Awal", sequential textual "scenes" with a "next" button. Background color/icon dynamically changes to reflect mood (e.g., initial sadness, joy of repentance, wonder of creation, sorrow of first sin). Added LLM-powered reflection button for deep thinking. 4. Inform/Summarize: Expandable cards for lessons, now with LLM-powered wisdom extraction buttons. 5. Engage: Direct questions for user reflection. Confirmed NO SVG/Mermaid. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #FDF8F0;
            color: #4E4234;
            transition: background-color 1s ease-in-out; /* Smooth transition for background changes */
        }
        .bg-primary { background-color: #FDF8F0; }
        .bg-secondary { background-color: #F5EFE1; }
        .text-primary { color: #4E4234; }
        .text-accent { color: #8D6B4C; }
        .border-accent { border-color: #D4A056; }
        .bg-accent { background-color: #D4A056; }
        .bg-accent-hover:hover { background-color: #C08C3B; }
        .shadow-custom { box-shadow: 0 10px 25px -5px rgba(141, 107, 76, 0.1), 0 4px 6px -4px rgba(141, 107, 76, 0.1); }
        .timeline-container {
            position: relative;
            padding-right: 2rem;
        }
        .timeline-line {
            position: absolute;
            right: 1.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #D4A056;
        }
        .timeline-event {
            position: relative;
            padding-right: 2rem;
            padding-bottom: 3rem;
            padding-top: 1rem;
        }
        .timeline-dot {
            position: absolute;
            right: -0.75rem;
            top: 1.5rem;
            width: 1.5rem;
            height: 1.5rem;
            background-color: #D4A056;
            border-radius: 50%;
            border: 3px solid #FDF8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #FDF8F0;
        }
        .timeline-content {
            background-color: #F5EFE1;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .timeline-content.active, .collapsible-header.active { /* Unified active state for both collapsible types */
            background-color: #EDE8D9; /* Slightly darker to show active state */
        }
        .timeline-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .timeline-details.open {
            max-height: 500px; /* Adjust based on content length */
            transition: max-height 0.7s ease-in;
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .arrow-icon {
            transition: transform 0.3s ease;
        }
        .arrow-icon.rotate {
            transform: rotate(90deg);
        }
        html {
            scroll-behavior: smooth;
        }

        /* Dynamic background and icon colors for the story section */
        #first-caliph-story {
            transition: background-color 1s ease-in-out;
        }
        .mood-initial { background-color: #E6DED0; } /* Slightly somber/neutral */
        .mood-hope { background-color: #DDEEE1; } /* Lighter, hopeful green */
        .mood-joy { background-color: #FDF8F0; } /* Default, bright */
        .mood-sadness { background-color: #E0E7EB; } /* Cooler, melancholic blue-grey */
        .mood-wonder { background-color: #EAE6D6; } /* Earthy, natural */
        .mood-tension { background-color: #F2DCD4; } /* Warmer, slightly unsettling */

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #D4A056;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-primary">
    <nav class="sticky top-0 z-50 bg-primary/80 backdrop-blur-md shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-accent">التاريخ كما أراه</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4 space-x-reverse">
                        <a href="#intro" class="text-primary hover:text-accent px-3 py-2 rounded-md text-sm font-medium">مقدمة لا بد منها</a>
                        <a href="#cycles" class="text-primary hover:text-accent px-3 py-2 rounded-md text-sm font-medium">استدارات الزمان</a>
                        <a href="#first-caliph-story" class="text-primary hover:text-accent px-3 py-2 rounded-md text-sm font-medium">قصة الخليفة الأول</a>
                        <a href="#lessons" class="text-primary hover:text-accent px-3 py-2 rounded-md text-sm font-medium">سنن وعبر</a>
                        <a href="#action" class="text-primary hover:text-accent px-3 py-2 rounded-md text-sm font-medium">دعوة للفعل</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <section id="intro" class="min-h-screen flex items-center justify-center text-center px-4 py-16">
            <div class="max-w-4xl">
                <h1 class="text-4xl md:text-6xl font-bold text-accent leading-tight">هدمٌ... ثم بناء!</h1>
                <p class="mt-6 text-lg md:text-xl text-primary max-w-2xl mx-auto">لتقرأ هذه الرواية في سياقها، فاعلم بأن قبلها عليك أن تعلم كيف أرى الزمان. دع عنك التاريخ القديم، ودع عنك الحضارات الأول. فقد يتبين لك عالم اليوم كما هو عليه الآن، وليس كما سُحر لك!</p>
                <p class="mt-4 text-lg md:text-xl text-primary max-w-2xl mx-auto">دع عنك الفراعين العظام، والعماليق الجبارين، والأساطير التي سُطرت، وكأنها تعاويذ فاستحكمت حتى ملكت عقول الناس، وصيَّروها حقًا!</p>
                <p class="mt-6 text-xl font-bold text-accent">قبل أن تمضي بعينيك على ما أكتبه. أفرغ عقلك من تُرَّهاتهم وأكاذيبهم.</p>
                <p class="mt-4 text-lg text-primary max-w-2xl mx-auto">فإن استعصى عليك فاسأل نفسك سؤالًا واحدًا: **هل تُصدق حقًا؛ بلا شك، ولا ريب، ولا احتمال!** هل حقًا ما جاءك من علم أمرٍ ما، فشاهدته وجرَّبته، كما ينص عليه قانونهم العلمي؟! هل استوفيت فيه، على نفسك، ولها؛ حقَّه من التمحيص حتى تقبله، وكأنه دين يعتنق؟! في أيِّ أمرٍ كانَ من أمرِ الدنيا، سل نفسك أولاً: أَبِلا شكٍ هذا؟</p>
                <p class="mt-4 text-lg text-primary max-w-2xl mx-auto">فإن اطمأننت إلى صدق المبلِّغ وصدق البلاغ. فلا خلاف فاقرأ. وإن شككت في صدق المبلِّغ وصدق البلاغ. فلا خلاف. فاقرأ! وأجر عليَّ ما أجريته على ما تعتقد، فلست بمعصوم عن الزلَّات والخطأ. وإنما أسأل الله السداد والتوفيق، وأن يعيذني من الشيطان أو أن يجري على قلمي سوءًا.</p>
                <div class="mt-8">
                    <a href="#cycles" class="bg-accent text-white font-bold py-3 px-8 rounded-full text-lg bg-accent-hover transition-all duration-300 transform hover:scale-105">ابحر في الزمان ✨</a>
                </div>
            </div>
        </section>

        <section id="cycles" class="py-20 bg-secondary">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-accent">استدارات الزمان</h2>
                    <p class="mt-4 text-lg text-primary max-w-2xl mx-auto">الزمان تاريخ دوران الأمم. لكل أمة لحظة نشوء، ثم تعلو في الزمان حتى تنقسم إلى فريقين، ثم نصر أو هزيمة. لنتتبع رحلة الإنسان منذ البكورة ونرى.</p>
                </div>

                <div class="mt-16 timeline-container">
                    <div class="timeline-line"></div>
                    <div class="timeline-event" onclick="toggleDetails(this)">
                        <div class="timeline-dot">1</div>
                        <div class="timeline-content rounded-xl shadow-custom">
                            <div class="collapsible-header">
                                <h3 class="text-xl font-bold text-accent">الاستدارة الأولى: من آدم إلى طوفان نوح</h3>
                                <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                            </div>
                            <div class="timeline-details mt-4">
                                <p class="text-primary">عندها بدأ القصص، والإعداد للتاريخ. أصْبَحَ آدم، عليه السلام؛ بعدما أُهبط من الجنة، هو أول التأريخ بشقيه البشري والمكاني، ثم أُضيف إليه الشق الزماني فجرى عليه. من آدم إلى ما قبل طوفان نوح، كان الناس أمة واحدة، ثم اختلفوا وبدلوا وغيروا، فبعث الله النبيين مبشرين ومنذرين، لتنتهي مع طوفان نوح استدارة الزمان الأولى مع الأمة الأولى.</p>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-event" onclick="toggleDetails(this)">
                        <div class="timeline-dot">2</div>
                        <div class="timeline-content rounded-xl shadow-custom">
                            <div class="collapsible-header">
                                <h3 class="text-xl font-bold text-accent">الاستدارة الثانية: من نوح إلى عاد وثمود</h3>
                                <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                            </div>
                            <div class="timeline-details mt-4">
                                <p class="text-primary">تبدأ الاستدارة الثانية منذ استواء الفلك على الجودي، وخروج المؤمنين مع نوح من السفينة لتبدأ مرحلة جديدة تتتابع فيها الأقوام، من نسل نوح وممن حملت الفلك معه. وانتهت هذه الاستدارة بأقوام عاد وثمود وغيرهما، وهي ما عرفت بين الناس بالقرون الأولى، وهي مرحلة ما قبل أول الرسالات.</p>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-event" onclick="toggleDetails(this)">
                        <div class="timeline-dot">3</div>
                        <div class="timeline-content rounded-xl shadow-custom">
                            <div class="collapsible-header">
                                <h3 class="text-xl font-bold text-accent">الاستدارة الثالثة: من إبراهيم إلى خطبة الوداع</h3>
                                <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                            </div>
                            <div class="timeline-details mt-4">
                                <p class="text-primary">تبدأ الاستدارة الثالثة بمقدمات ميلاد ابني إبراهيم، إسماعيل وإسحاق، ورفع القواعد من بيت الله بعدما كان البيت، بيت الله، منسياً بذاكرة البشر. لتبدأ رسالة التوحيد مقرونة بكتاب إلى الأقوام التي اختارها الله على علم: التوراة، والإنجيل، والقرآن. وبخطبة الوداع، التي ذكرنا طرفاً منها في بداية هذه المقدمة؛ تنتهي الاستدارة الثالثة.</p>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-event" onclick="toggleDetails(this)">
                        <div class="timeline-dot">4</div>
                        <div class="timeline-content rounded-xl shadow-custom">
                            <div class="collapsible-header">
                                <h3 class="text-xl font-bold text-accent">الاستدارة الرابعة والأخيرة: زماننا الآن</h3>
                                <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                            </div>
                            <div class="timeline-details mt-4">
                                <p class="text-primary">منذ هذه اللحظة انتهت استدارة زمان، وبدأ الزمان استدارة جديدة كهيئته يوم خلق الله السموات والأرض. دورة جديدة للزمان، حيث المؤمنون كثر، وللإيمان دولة وعقد ونظام. ونحن نعيش الآن في دقات ساعتها. كل مثل لأمة ذكرت في هذه الرواية، هو مثل لأمم من بيننا عاشت، لها شبيه سبقها في استدارة زمانه في أفعالها. هذا هو زمان المواجهة الكبرى الذي يتطلب الوعي والفعل.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="first-caliph-story" class="py-20 text-center px-4 mood-initial">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-accent">قصة الخليفة الأول: آدم</h2>
                <p class="mt-4 text-lg text-primary max-w-2xl mx-auto">هيا ننطلق في رحلةٍ مبهجةٍ لاتباع الأثر الذي تركه الخليفة الأول. واعلم بأن لزام انطلاقها هو رؤيتي. فإن أحسست فيها بالتعب فتوقف، ولا تقرأ. لأنك إن قرأت متعبًا، ومرَّ على عينيك ما أقول في عجالةٍ بلا مُماحصةٍ منك؛ فلن تقبل ما بعدها. لأنك حينها ستخالف الرؤية التي انطلقنا منها. لا تدع شيئًا يمر دون تمحيصٍ. فلستُ إلا واحدًا في غمارِ الناسِ، أقولُ برأيي. وتذكرْ، أن كلًا يؤخذ ويُردّ منه إلا نبيُّ الله الأكرم، صلى الله عليه وسلم. بسم الله نبدأ.</p>
                
                <div id="story-content" class="mt-10 bg-secondary p-8 rounded-xl shadow-custom">
                    <p id="story-text" class="text-xl text-primary leading-relaxed"></p>
                    <div class="mt-6 text-5xl">
                        <span id="story-icon"></span>
                    </div>
                </div>
                <div class="mt-8 flex justify-center space-x-4 space-x-reverse">
                    <button id="prev-scene" class="bg-accent text-white font-bold py-3 px-8 rounded-full text-lg bg-accent-hover transition-all duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed">السابق</button>
                    <button id="next-scene" class="bg-accent text-white font-bold py-3 px-8 rounded-full text-lg bg-accent-hover transition-all duration-300 transform hover:scale-105">التالي</button>
                </div>
                <div class="mt-4 text-primary">
                    <span id="current-scene-indicator">1</span> / <span id="total-scenes-indicator"></span>
                </div>
                <div class="mt-6">
                    <button id="reflect-scene" class="bg-accent text-white font-bold py-3 px-8 rounded-full text-lg bg-accent-hover transition-all duration-300 transform hover:scale-105">تأمل في المشهد ✨</button>
                    <div id="reflection-output" class="mt-4 p-4 bg-primary rounded-lg shadow-inner text-primary hidden">
                        <div class="loading-spinner hidden"></div>
                        <p></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="lessons" class="py-20 bg-primary">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-accent">سنن وعبر من التاريخ</h2>
                    <p class="mt-4 text-lg text-primary max-w-2xl mx-auto">التاريخ لا يروي الأحداث فقط، بل يكشف عن السنن الإلهية الثابتة. انقر لترى بعض هذه السنن وكيف تتجلى في كل دورة زمان.</p>
                </div>

                <div class="mt-16 grid gap-10 md:grid-cols-2 lg:grid-cols-3">
                    <div class="bg-secondary p-6 rounded-xl shadow-custom transform hover:-translate-y-2 transition-transform duration-300 collapsible-header" onclick="toggleDetails(this)">
                        <h3 class="text-xl font-bold text-accent">سنة الزوال</h3>
                        <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                        <div class="timeline-details mt-4">
                            <p class="text-primary">أقوام ناطحوا السحاب قوةً ومالاً وتكبرًا، ثم طغوا وتجبروا. ولما بلغوا بطغواهم إلى المنتهى، انتهوا! لا بقاء لظلم أو كبر مهما بلغت قوة أصحابه.</p>
                            <button class="extract-wisdom mt-4 bg-accent text-white font-bold py-2 px-6 rounded-full text-sm bg-accent-hover transition-all duration-300">استخلص حكمة ✨</button>
                            <div class="wisdom-output mt-3 p-3 bg-primary rounded-lg shadow-inner text-primary hidden">
                                <div class="loading-spinner hidden"></div>
                                <p></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-secondary p-6 rounded-xl shadow-custom transform hover:-translate-y-2 transition-transform duration-300 collapsible-header" onclick="toggleDetails(this)">
                        <h3 class="text-xl font-bold text-accent">سنة الابتلاء</h3>
                        <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                        <div class="timeline-details mt-4">
                            <p class="text-primary">إن ما على الأرض زينة لها، وإنما جعلها الله ليبلو الناس أيهم أحسن عملاً. الدنيا ليست غاية، بل هي اختبار وتمحيص يظهر فيه الصادق من الكاذب.</p>
                            <button class="extract-wisdom mt-4 bg-accent text-white font-bold py-2 px-6 rounded-full text-sm bg-accent-hover transition-all duration-300">استخلص حكمة ✨</button>
                            <div class="wisdom-output mt-3 p-3 bg-primary rounded-lg shadow-inner text-primary hidden">
                                <div class="loading-spinner hidden"></div>
                                <p></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-secondary p-6 rounded-xl shadow-custom transform hover:-translate-y-2 transition-transform duration-300 collapsible-header" onclick="toggleDetails(this)">
                        <h3 class="text-xl font-bold text-accent">سنة التغيير</h3>
                        <span class="arrow-icon text-accent text-2xl">&#9658;</span>
                        <div class="timeline-details mt-4">
                            <p class="text-primary">حتى الأمم الواحدة التي تبدأ على الحق، قد تختلف وتبدل وتغير. هذا يظهر أهمية التجديد المستمر للوعي والتمسك بالحق، وعدم الركون إلى ما مضى.</p>
                            <button class="extract-wisdom mt-4 bg-accent text-white font-bold py-2 px-6 rounded-full text-sm bg-accent-hover transition-all duration-300">استخلص حكمة ✨</button>
                            <div class="wisdom-output mt-3 p-3 bg-primary rounded-lg shadow-inner text-primary hidden">
                                <div class="loading-spinner hidden"></div>
                                <p></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="action" class="py-20 bg-secondary">
            <div class="max-w-3xl mx-auto text-center px-4">
                <h2 class="text-3xl font-bold text-accent">دعوة للفعل: الآن وقد علمت!</h2>
                <p class="mt-4 text-lg text-primary">الآن، وقد تجهزت بما يكفي من الوعي، فامخر عباب البحر ولا تهاب. اعلم أن التاريخ للناظر منا، يبدأ من لحظة تكليف الإنسان كخليفة. ولِترى التاريخ حيًا ليس بخامداً، ولتراه ينتصر لهذا الرجل: تتبعه، واعتقد ما اعتقده!</p>
                <p class="mt-6 text-xl font-bold text-accent">هذه الرواية إنما تبغي أن يُبحر القارئ بين حاضرنا مُسلحاً؛ بما يجب عليه أن يدركه من التاريخ، والعبر.</p>
                <div class="mt-8">
                     <p class="2xl font-bold text-primary">ما هي خطوتك الآن؟ كيف ستكتب قصة زمانك؟</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-primary">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-primary">
            <p>&copy; 2025 التاريخ كما أراه - رحلة في الزمان والوعي.</p>
        </div>
    </footer>

    <script>
        let currentSceneIndex = 0;
        const storyScenes = [
            {
                text: "انظر للذي هبط من الجنة يوارِي سَوْأتُه بلباسٍ من التقوى، وريشًا! عَلَى هٰذِهِ الأَرْضِ العَذْراءِ البِكْرِ البَعِيدَةِ عَنْ عَبَثِ الإِنْسانِ وَإِفْسادِهِ. اُنْظُرْ إِلَى الأَرْضِ وَكَأَنَّها ثَمَرَةٌ ناضِجَةٌ، مَلْأى بِالبَرَكَةِ وَمُسَخَرَةٍ لِلإِنْسانِ.",
                icon: "🌿",
                mood: "mood-initial"
            },
            {
                text: "إلقِ بِنَظْرَةٍ مُتَفَحِّصَةٍ، وَقَدْ تَرَى عَلَى مُحَيّاهُ حُزْنًا بادِيًا. أَمْ إِنَّ هذا خَوْفٌ! أَمْ كِلاهُما! قَدْ حِرْتَ فِيهِ. يَبْدُو كَما لَوْ كانَتْ كُلُّ مَشاعِرِهِ قَدْ اِخْتَلَجَتْ فَبانَتْ عَلَيْهِ. وَهُوَ يَشُقُّ الطَرِيقَ واسِعَ الخُطَى مُسْرِعاً، مُتَأَمِّلًا وَمُفَكِّرًا. لِنَلْحَقْ بِهِ. فَلا نَفْقِدُهُ الآنَ.",
                icon: "😔",
                mood: "mood-sadness"
            },
            {
                text: "حَسَنًا. ها هُوَ! نَراهُ الآنَ وَقَدْ تَهَلَّلَتْ أَسارِيرُهُ وَيُعِيدُ عَلَى شَفَتَيْهِ وَلِسانِهِ ما تَلَقّاهُ مِنْ اللهِ مِنْ كَلِماتٍ، مَرَّةً بَعْدَ أُخْرَى. يَبْدُو الآنَ أَنَّ اللهَ؛ وَلَهُ الحَمْدُ وَحْدَهُ أَنْ أَلْقَى إِلَيْهِ بِهٰذِهِ الكَلِماتِ، قَدْ تابَ عَلَيْهِ، فَقَدْ ظَهَرَ عَلَى مُحَيّاهُ آثارُها.",
                icon: "✨",
                mood: "mood-hope"
            },
            {
                text: "اِلْحَقْ بِهِ ثانِيَةً! إِلَى أَيْنَ يَذْهَبُ؟! إِنَّهُ يَحُثُّ الخُطَى لَيْلَ نَهارٍ؛ إِلّا مِنْ تَعَبِ! آهُ. زَوْجُهُ! لَقَدْ نَسْيِتُ أَمْرَها تَماماً! إِمّا إِنَّهُ يَبْحَثُ عَنْها، أَوْ أَنَّهُ يَذْهَبُ إِلَيْها عَلَى مَوْعِدٍ! وَإِلّا، فَمَنْ سِواها! إِنَّها سَكَنُهُ، وَمَنْ خُلِقَتْ مِنْ ضِلْعٍ فِيهِ، وَهِيَ بَعْضُ نَفْسِهِ، الضَعِيفُ إِلَيْها وَالضَعِيفَةُ إِلَيْهِ. لابُدَّ أَنَّ بَيْنَهُما مَوْعِدًا.",
                icon: "🚶",
                mood: "mood-initial"
            },
            {
                text: "وَلَكِنْ، تُرَى كَيْفَ يَلْتَقِيانِ عَلَى هٰذِهِ الأَرْضِ الواسِعَةِ؟! كَيْفَ يَتَقابَلا! كَيْفَ اِسْتَدَلَّ كِلاهُما عَنْ مَكانِ الآخَرِ! لَوْ عَلِمْتَ أَنَّ آدَم أَوَّلَ البَشَرِ، وَأَوَّلَ الناسِ. وَقَدْ قالَ اللهُ جَلَّ وَعَلاْ: ﴿إِنَّ أَوَّلَ بَيْتٍ وُضِعَ لِلناسِ لِلَّذِي بِبَكَةَ﴾، فَإِنَّكَ قَدْ تَسْتَنْبِطُ أَنَّ البَيْتَ الَّذِي بِمَكَّةَ هُوَ أَوَّلُ بَيْتٍ بَدْءً مِنْ آدَمَ. فَيَكُونُ لِلأُنْسِ بِهِ ﴿مُبارَكًا﴾، وَلِلاِسْتِدْلالِ عَنْهُ ﴿وَهُدًى لِلعالَمِينَ﴾. لِذا، فَيُمْكِنُكَ القَوْلُ بِأَنَّ آدَم وَزَوْجَهُ قَدْ اِسْتَدَلّا عَنْ بَعْضِهِما بِهُدًى يَخْرُجُ مِنْ هذا المَكانِ يُرِيهِ اللهُ لِمَنْ يَشاءُ مِنْ عِبادِهِ. لِيُناسِبَ ما سُمِّيَ بِهِ. البَيْتُ العَتِيقُ.",
                icon: "🕋",
                mood: "mood-hope"
            },
            {
                text: "الآنَ وَقَدْ عَلِمْتُ أَيْنَ يَذْهَبُ. وَمَنْ سَيُقابِلُ. فَلْنَتْبَعْهُ الآنَ وَهُوَ يَمْضِي مُتَيَقِّظًا بَيْنَ الأَشْجارِ المُتَشابِكَةِ الَّتِي صَنَعَتْ هٰذِهِ الغاباتِ. إِنَّها تَحْوي عَجائِبَ لِلخَلْقِ، وَهُوَ يَمْضِي فَيَرَى مَخْلُوقاً فَيَتَأَمَّلُهُ، ثُمَّ يَرَى شَجَرَةً قَدْ اِسْتَطالَتْ حَتَّى عَلَتْ وَتَشابَكَتْ أَغْصانُها حَتَّى كَأَنَّها تَظِلُّهُ مِنْ شَمْسِ هٰذِهِ الدُنْيا. وَيَمْضِي هُوَ. لَعَلَّهُ يَرَى ما لا نَرَى، فَإِنَّ طَرِيقَهُ الَّذِي يَسْلُكُهُ يَبْدُو وَكَأَنَّهُ يَعْلَمُهُ. هذا لا يَبْحَثُ عَنْ طَرِيقٍ. هذا سُلُوكُ مَنْ عَرِفَ الطَرِيقِ.",
                icon: "🌳🦌",
                mood: "mood-wonder"
            },
            {
                text: "وَلَقَدْ وَصَلْنا الآنَ إِلَى أَرْضٍ مُرُوجِها الخَضْراءِ قَدْ اِمْتَدَّتْ حَتَّى مَلَأَتْ الأُفُقَ، بِأَنْهارٍ وَجَداوِلَ مِنْ الماءِ تَنْزِلُ مِنْ عَلَى الجِبالِ المُحِيطَةِ بِهٰذِهِ البُقْعَةِ البَدِيعَةِ، إِلَى جِبالٍ وَوادٍ. ما هٰذِهِ الأَرْضُ؟! آه! هُنا اِلْتَقَيا! لا بُدَّ أَنَّ هذا هُوَ جَبَلُ عَرَفَةَ! فَأعلاهُ قد تَعارَفاْ عَلَى الأَرْضِ. لَقَدْ وَجَدا بَعْضَهُما! عِنْدَ البَيْتِ.",
                icon: "🏞️🤝",
                mood: "mood-joy"
            },
            {
                text: "مِنْ هذِهِ النُقْطَةِ، عَلَيْكَ أَنْ تَعْلَمَ بِبَعْضِ الأُمُورِ حَتَّى تَكُونَ عَلَى قَبُولٍ بِما سَأَقُولُ. لَوْ قُدِّرَ لَكَ أَنْتَ أَنْ تَرْكَبَ سَفِينَةً إِلَى مَكانٍ ما بَحْثًا عَنْ رِزْقٍ أَوْ عَمَلٍ أَوْ هِجْرَةٍ. وَبَيْنَما أَنْتَ فِي السَفِينَةِ إِذْ يَثُورُ البَحْرُ وَيَهِيجُ وَيَعْلُو المَوْجُ حَتَّى يَصِيرَ جِبالاً. وَتَنْقَلِبُ سَفِينَتُكَ بِمَنْ مَعَكَ وَتَنْجُو! إِلَى جَزِيرَةٍ مِنْ صَخْرٍ وَشاطِئِها يَسْبِقُ زَرْعًا وَشَجَرًا وَقَدْ يَكُونُ غاباتٍ. فَإِنَّكَ أَوَّلُ ما سَتَسْكُنُ هُوَ أَقْرَبُ ما يَكُونُ إِلَى سَبِيلِ نَجاتِكَ، فَلَنْ تَعْدُوَ الشاطِئَ كَثِيرًا، وَرُبَّما حاوَلْتُ أَنْ تُقِيمَ لِنَفْسِكَ مَلْجَئًا مِنْ شَجَرٍ أَوْ حَجَرٍ؛ أَوْ لَرُبَّما بَحَثْتُ حَتَّى وَجَدْتُ شَقّاً فِي الجِبالِ قَرِيبٌ مِنْ الشاطِئِ وَاِطْمَئْنَنْتُ إِلَيْهِ ثُمَّ اِتَّخَذْتُهُ مَلْجَأً.",
                icon: "🚢🏝️",
                mood: "mood-initial"
            },
            {
                text: "فَالشاطِئُ فِيهِ طَعامٌ؛ وَفِيهِ بَعْضُ الأَمانِ بِاِتِّساعِ الرُؤْيَةِ كَما وَأَنَّهُ قَدْ يَكُونُ فِيهِ سَبِيلٌ لِسَفِينَةٍ تَمُرُّ وَتُنْجِدُكَ!. وَلَوْ طالَ بِكَ المُقامُ بِهٰذِهِ الأَرْضِ لَوَجَدْتَ نَفْسَكَ دُونَ عِلْمٍ مُسْبَقٍ قَدْ صِرْتَ نَجّارًا وَحَطّابًا وَحِدّادًا وَلَرُبَّما مُزارِعًا وَصَيّادًا وَمُخْتَرِعًا وَفَنّاناْ. سَتُحَوِّلُكَ فِطْرَتُكَ إِلَى الاِسْتِخْدامِ الأَمْثَلِ مِنْ البِيئَةِ دُونَ إِفْراطٍ؛ وَلَتَجِدَنَّ نَفْسَكَ لا تَصْنَعُ مِقْعَدَيْنِ إِنْ كُنْتَ مُحْتاجًا لِواحِدٍ فَقَطْ. فَلَنْ تَقْطَعَ شَجَرَةً إِلّا بِغَرَضِ الاِسْتِفادَةِ دُونَ إِفْراطٍ. هٰكَذا سَتُصْبِحُ! هٰذِهِ مَهاراتٌ لازِمَةٌ لِكَيْ تَنْجُوَ. كَيْ تَحْيا تَحْتاجُ أَنْ تَأْمَنَ مِنْ خَوْفٍ وَأَنْ تَأْمَنَ مِنْ جُوعٍ؛ بَلْ إِنَّكَ أَوَّلاً تَحْتاجُ أَنْ تَأْمَنَ مِنْ جُوعٍ، ثُمَّ تَأْمَنَ مِنْ خَوْفٍ.",
                icon: "🛠️🍎",
                mood: "mood-wonder"
            },
            {
                text: "فَلْنَعُدْ إِلَى آدَمَ وَقَدْ فَهِمْتُ ما قَدْ تَكُونُ أَنْتَ إِنْ اُضْطُرِرْتَ أَنْ تَنْجُوَ. بَلْ إِنْ أُمِرْتَ أَنْ تُعَمِّرَ وَتُسْتَخْلَفَ فِي الأَرْضِ؛ فَالعِلْمُ أَعْظَمُ وَالفِعْلُ أَلْيَقُ. فَإِنْ عُدْنا إِلَى آدَمَ وَجَدْناهُ وَقَدْ عَلِمَ الأَسْماءَ كُلَّها، وَقَدْ عَلِمَ الحَدِيدُ ما شَكْلُهُ، وَأَيْنَ يُوجَدُ فِي هٰذِهِ الأَرْضِ، وَفِي أَيِّ صُورَةٍ، وَكَيْفَ يُسْتَخْرَجُ وَكَيْفَ يُشَكَّلُ، حَتَّى يَصِيرَ فَأْساً، أَوْ سِكِّيناْ. فَإِنْ اِحْتاجَ لِنَفْسِهِ بَيْتًا بِجِوارِ بَيْتِ اللهِ الحَرامِ؛ فَعَلَيْهِ أَنْ يَبْنِيَهُ أَوَّلًا مِنْ بِيئَتِهِ الَّتِي حَوْلَهُ. فَلا أَظُنُّهُ يَبْنِيهِ بِالطِينِ وَالقَشِّ إِنْ كانَ فِي أَرْضٍ تُنْبِتُ الصَخْرُ، وَلا يَبْنِيهِ بِحِجارَةٍ فِي أَرْضٍ سُكْناها الشَجَرُ. لذا فقَدْ بَنَى بَيْتَهُ مِمّا يَتَوَفَّرُ لَهُ فِي بِيئَتِهِ حَوْلَ البَيْتِ.",
                icon: "🏠✨",
                mood: "mood-hope"
            },
            {
                text: "اِقْتَرِبْ. هَيّا! هَلْ تَرَى الأَطْفالَ الَّذِينَ يَلْعَبُونَ حَوْلَ بَيْتِ آدَم المُطِلِّ عَلَى البَيْتِ العَتِيقِ فِي سَعادَةٍ؟! ثُمَّ اُنْظُرْ. هذانِ هُما اِبْنَيْ آدَمَ! يَعْلَمانِ يَقِينًا أَنَّ أَباهُما أَوَّلَ البَشَرِ، وَإنَّهُ خُلِقَ بِيَدِ اللهِ؛ وَإنَّ الشَيْطانَ عَدُوَّهُ وَإنَّهُمْ قَدْ أُهْبِطُوا جَمِيعاً مِنْ الجَنَّةِ، وَإنَّهُمْ راجِعُونَ إِلَى اللهِ.",
                icon: "👨‍👩‍👧‍👦",
                mood: "mood-joy"
            },
            {
                text: "فَما الَّذِي دَفَعَ أَحَدَهُما إِلَى أَنْ يَقْتُلَ الآخَرَ هٰكَذا؟ ما الَّذِي جَدَّ. ما الَّذِي حَدَثَ حَتَّى يَرْتَكِبَ أَعْظَمَ الذُنُوبِ واحِدًا مِنْ أوائِلِ الناسِ. حَسَنًا؛ لِنَنْظُرْ إِلَى القاتِلِ وَنَقْرَأَ ما كُتِبَ عَلَى مُحَيّاهُ. قالَ لَأَقْتُلَنَّك. أَفَلا قُلْتَ لَأَضْرِبَنَّكَ؟! لِمَا اِنْطَلَقْتَ بِالقَوْلِ حَتَّى قُلْتَ لَهُ لَأَقْتُلَنَّكَ؟ لِمَا رَأَيْتَهُ مُسْتَحِقًّا لِهذا القَتْلِ.",
                icon: "🔪❓",
                mood: "mood-tension"
            },
            {
                text: "مِمّا قالَهُ الشَيْطانُ لَمَّا سُئِلَ عَمّا مَنَعَهُ أَنْ يَكُونَ مَعَ الساجِدِينَ، قَالَ أَنَا خَيْرٌ مِنْهُ؛ خَلَقْتَنِي مِنْ نَارٍ، وَخَلَقْتَهُ مِنْ طِينٍ. فَكانَ أَنْ ظَنَّ أَنَّ النارَ خَيْرٌ مِنْ الطِينِ بِزَعْمِهِ مُساوِيًا لِأَنْ يَقُولَ أَحَدُهُمْ أَنَّ الطِينَ خَيْرًا مِنْ الماءِ أَوْ أَنَّ النُورَ خَيْرًا مِنْ الطِينِ. لَيْسَ لِأَحَدٍ! فَالخَيْرُ كُلُّ الخَيْرِ فِيما أَمَرَ بِهِ اللهُ.",
                icon: "😈🔥",
                mood: "mood-tension"
            },
            {
                text: "هُنا نَرَى القاتِلَ وَالمَقْتُولَ قَدْ قَدَّماْ قُرْبانًا، وَلَعَلِّي لَمْ أَنْتَبِهْ فِيما كانَ القُرْبانُ أَصْلًا. أَهُوَ قُرْبانٌ لِلقُرْبِ مِنْ اللهِ، أَوْ قُرْبانًا لِلحُكْمِ بَيْنَهُما فِيما اِخْتَلَفا فِيهِ! أَمْ كِلاهُما؛ أَوْ رُبَّما غَيْرُ هذا وَذاكَ! اللهُ أَعْلَمُ. وَلٰكِنَّهُما اِبْنَي آدَمَ! أَوائِلُ الناسِ عُمْرًا وَأَسْبَقَهُمْ إِلَى بَوّابَةِ التارِيخِ؛ وَعِلْمًا بِالقِصَّةِ الأُولَى وَقُرْبًا مِنْ الراوِي! أَوَّلَ الإِنْسانِيَّةِ قَتَلَتْ بَعْضَها، فَأفْسَدَتْ فِي الأَرْضِ وَسَفَكَتْ دَمَها!. وَهكَذا سَتَمْضِي! وَهكَذا بَدَأَ صَباحُ الزَمانِ.",
                icon: "🩸😔",
                mood: "mood-sadness"
            },
            {
                text: "أَرَأَيْتَ الآنَ كَيْفَ يَمْضِي الوَقْتُ وَقَدْ أنْجَبَ آدَم بَنِيْهِ وَزادَ بَنِيْهِمْ وَكَثُرُوا. أَرَأَيْتَ كَيْفَ زادَ العُمْرانُ حَوْلَ البَيْتِ فَصارَ بَيْتُ آدَم بُيُوتًا حَوْلَ بَيْتِ اللهِ مُجْتَمِعَةً. هذِهِ نَواةُ الأُمَّةِ الأُولَى. لا مُنافِسَ وَلا مُساوِيَ، وَلا جِنْسَ سِواهُمْ. وَالجِنُّ!",
                icon: "🏡👨‍👩‍👧‍👦",
                mood: "mood-initial"
            }
        ];

        const sunanLessons = [
            {
                title: "سنة الزوال",
                text: "أقوام ناطحوا السحاب قوةً ومالاً وتكبرًا، ثم طغوا وتجبروا. ولما بلغوا بطغواهم إلى المنتهى، انتهوا! لا بقاء لظلم أو كبر مهما بلغت قوة أصحابه."
            },
            {
                title: "سنة الابتلاء",
                text: "إن ما على الأرض زينة لها، وإنما جعلها الله ليبلو الناس أيهم أحسن عملاً. الدنيا ليست غاية، بل هي اختبار وتمحيص يظهر فيه الصادق من الكاذب."
            },
            {
                title: "سنة التغيير",
                text: "حتى الأمم الواحدة التي تبدأ على الحق، قد تختلف وتبدل وتغير. هذا يظهر أهمية التجديد المستمر للوعي والتمسك بالحق، وعدم الركون إلى ما مضى."
            }
        ];

        function toggleDetails(clickedContainer) {
            let detailsElement;
            let arrowIcon;
            let headerElement;

            // For timeline-event, the content is inside .timeline-content
            if (clickedContainer.classList.contains('timeline-event')) {
                headerElement = clickedContainer.querySelector('.collapsible-header');
                detailsElement = clickedContainer.querySelector('.timeline-details');
                arrowIcon = clickedContainer.querySelector('.arrow-icon');
            } 
            // For collapsible-header in lessons, the clicked element itself is the header
            else if (clickedContainer.classList.contains('collapsible-header')) {
                headerElement = clickedContainer;
                detailsElement = clickedContainer.querySelector('.timeline-details');
                arrowIcon = clickedContainer.querySelector('.arrow-icon');
            } else {
                return; // Not a recognized clickable element
            }

            if (detailsElement && arrowIcon) {
                if (detailsElement.classList.contains('open')) {
                    detailsElement.classList.remove('open');
                    headerElement.classList.remove('active');
                    arrowIcon.classList.remove('rotate');
                } else {
                    detailsElement.classList.add('open');
                    headerElement.classList.add('active');
                    arrowIcon.classList.add('rotate');
                }
            }
        }

        let currentScene = 0;
        const storyTextElement = document.getElementById('story-text');
        const storyIconElement = document.getElementById('story-icon');
        const prevSceneButton = document.getElementById('prev-scene');
        const nextSceneButton = document.getElementById('next-scene');
        const currentSceneIndicator = document.getElementById('current-scene-indicator');
        const totalScenesIndicator = document.getElementById('total-scenes-indicator');
        const storySection = document.getElementById('first-caliph-story');
        const reflectSceneButton = document.getElementById('reflect-scene');
        const reflectionOutput = document.getElementById('reflection-output');
        const reflectionText = reflectionOutput.querySelector('p');
        const reflectionSpinner = reflectionOutput.querySelector('.loading-spinner');

        function updateScene() {
            const scene = storyScenes[currentScene];
            storyTextElement.textContent = scene.text;
            storyIconElement.textContent = scene.icon;

            // Update background mood
            storySection.classList.remove(...Array.from(storySection.classList).filter(c => c.startsWith('mood-')));
            storySection.classList.add(scene.mood);

            // Update navigation buttons
            prevSceneButton.disabled = currentScene === 0;
            prevSceneButton.classList.toggle('opacity-50', currentScene === 0);
            prevSceneButton.classList.toggle('cursor-not-allowed', currentScene === 0);
            
            nextSceneButton.disabled = currentScene === storyScenes.length - 1;
            nextSceneButton.classList.toggle('opacity-50', currentScene === storyScenes.length - 1);
            nextSceneButton.classList.toggle('cursor-not-allowed', currentScene === storyScenes.length - 1);

            currentSceneIndicator.textContent = currentScene + 1;
            
            // Clear previous reflection when scene changes
            reflectionOutput.classList.add('hidden');
            reflectionText.textContent = '';
        }

        prevSceneButton.addEventListener('click', () => {
            if (currentScene > 0) {
                currentScene--;
                updateScene();
            }
        });

        nextSceneButton.addEventListener('click', () => {
            if (currentScene < storyScenes.length - 1) {
                currentScene++;
                updateScene();
            }
        });

        async function generateReflection() {
            reflectionOutput.classList.remove('hidden');
            reflectionText.textContent = '';
            reflectionSpinner.classList.remove('hidden');

            const currentSceneText = storyScenes[currentScene].text;
            const prompt = `استخرج سؤالاً تأملياً عميقاً أو بصيرة روحية/فلسفية موجزة من النص التالي، لتشجيع القارئ على التفكير في مغزى القصة وعلاقتها بحياته. اجعل الإجابة باللغة العربية الفصحى:\n\n"${currentSceneText}"`;
            
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    reflectionText.textContent = result.candidates[0].content.parts[0].text;
                } else {
                    reflectionText.textContent = 'تعذر توليد التأمل حالياً. حاول مرة أخرى.';
                }
            } catch (error) {
                console.error('Error generating reflection:', error);
                reflectionText.textContent = 'حدث خطأ أثناء الاتصال بالنموذج. حاول مرة أخرى.';
            } finally {
                reflectionSpinner.classList.add('hidden');
            }
        }

        reflectSceneButton.addEventListener('click', generateReflection);

        async function extractWisdom(button) {
            const wisdomOutputDiv = button.nextElementSibling; // The div with wisdom-output class
            const wisdomTextElement = wisdomOutputDiv.querySelector('p');
            const wisdomSpinner = wisdomOutputDiv.querySelector('.loading-spinner');

            wisdomOutputDiv.classList.remove('hidden');
            wisdomTextElement.textContent = '';
            wisdomSpinner.classList.remove('hidden');

            const lessonText = button.previousElementSibling.textContent; // Text of the p tag before the button
            const prompt = `استخلص حكمة عملية أو مثالاً معاصراً من السنة التاريخية التالية، مع التركيز على علاقتها بحياة الإنسان اليومية. اجعل الإجابة باللغة العربية الفصحى:\n\n"${lessonText}"`;
            
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    wisdomTextElement.textContent = result.candidates[0].content.parts[0].text;
                } else {
                    wisdomTextElement.textContent = 'تعذر استخلاص الحكمة حالياً. حاول مرة أخرى.';
                }
            } catch (error) {
                console.error('Error extracting wisdom:', error);
                wisdomTextElement.textContent = 'حدث خطأ أثناء الاتصال بالنموذج. حاول مرة أخرى.';
            } finally {
                wisdomSpinner.classList.add('hidden');
            }
        }

        window.onload = function() {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            totalScenesIndicator.textContent = storyScenes.length;
            updateScene();

            // Add event listeners for extract wisdom buttons
            document.querySelectorAll('.extract-wisdom').forEach(button => {
                button.addEventListener('click', () => extractWisdom(button));
            });
        };
    </script>
</body>
</html>
